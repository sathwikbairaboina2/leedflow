from enum import Enum
from typing import List, Dict, Set

from app.utils.fuzzy import correct_name


# Define the country enumeration
class ScandinavianCountry(Enum):
    Norway = 1
    Sweden = 2
    Denmark = 3
    Iceland = 4
    FaroeIslands = 5


# --- Country-specific rules ---
norwegian_rules = {
    # Vowel combinations and single vowels
    "a": ["å", "a"],
    "ae": ["æ", "ø"],
    "oe": ["ø", "ö"],
    "aa": ["å"],
    "ao": ["å"],
    "e": ["e", "æ"],
    "ea": ["æ", "e"],
    "ee": ["e"],
    "ei": ["ei", "ai"],
    "eu": ["ø"],
    "i": ["i"],
    "ie": ["ie", "i"],
    "io": ["io"],
    "iu": ["iu"],
    "o": ["o", "ø"],
    "oo": ["ø", "u"],
    "ou": ["ou", "u"],
    "oy": ["øy"],
    "u": ["u", "y"],
    "ue": ["ü", "y"],
    "ui": ["ui"],
    "uy": ["y"],
    "y": ["y", "i"],
    "ya": ["ja"],
    "ye": ["je"],
    "yi": ["ji"],
    "yo": ["jo"],
    "yu": ["ju"],
    # Consonant combinations
    "b": ["b"],
    "bb": ["bb"],
    "bt": ["bt"],
    "c": ["k", "s"],
    "cc": ["kk"],
    "ch": ["kj", "sj"],
    "ck": ["kk"],
    "d": ["d"],
    "dd": ["dd"],
    "dg": ["g"],
    "dj": ["j"],
    "dt": ["t"],
    "f": ["f"],
    "ff": ["ff"],
    "ft": ["ft"],
    "g": ["g"],
    "gg": ["gg"],
    "gh": ["g", ""],
    "gn": ["gn"],
    "gu": ["g"],
    "h": ["h", ""],
    "hl": ["l"],
    "hn": ["n"],
    "hr": ["r"],
    "ht": ["t"],
    "j": ["j"],
    "k": ["k"],
    "kk": ["kk"],
    "kn": ["kn"],
    "l": ["l"],
    "ll": ["ll"],
    "ln": ["ln"],
    "lt": ["lt"],
    "m": ["m"],
    "mb": ["m"],
    "mm": ["mm"],
    "mn": ["mn"],
    "mp": ["mp"],
    "n": ["n"],
    "nd": ["nd"],
    "ng": ["ng"],
    "nk": ["nk"],
    "nn": ["nn"],
    "nt": ["nt"],
    "p": ["p"],
    "ph": ["f"],
    "pp": ["pp"],
    "pt": ["pt"],
    "qu": ["kv"],
    "r": ["r"],
    "rr": ["rr"],
    "rt": ["rt"],
    "s": ["s"],
    "sc": ["sk"],
    "sh": ["sj", "skj"],
    "sk": ["sk"],
    "sl": ["sl"],
    "sm": ["sm"],
    "sn": ["sn"],
    "sp": ["sp"],
    "ss": ["ss"],
    "st": ["st"],
    "sw": ["sv"],
    "t": ["t"],
    "th": ["t", ""],
    "tt": ["tt"],
    "tw": ["tv"],
    "v": ["v"],
    "w": ["v"],
    "wh": ["v", "h"],
    "wr": ["r"],
    "x": ["ks"],
    "z": ["s"],
    # Common English name endings to Norwegian
    "son": ["sen", "søn"],
    "sen": ["sen"],
    "berg": ["berg"],
    "burg": ["borg"],
    "ley": ["li"],
    "lyn": ["lin"],
    "ton": ["ton"],
    "ham": ["ham"],
    "ford": ["ford"],
    "wood": ["ved"],
    "field": ["felt"],
    "land": ["land"],
    "man": ["mann"],
    "er": ["er"],
    "ard": ["ard"],
    "and": ["and"],
}

swedish_rules = {
    # Vowel combinations and single vowels
    "a": ["å", "a"],
    "ae": ["æ", "ö"],
    "oe": ["ö", "ø"],
    "aa": ["å"],
    "ao": ["å"],
    "e": ["e", "ä"],
    "ea": ["ä", "e"],
    "ee": ["e"],
    "ei": ["ej", "ai"],
    "eu": ["ö"],
    "i": ["i"],
    "ie": ["ie", "i"],
    "io": ["io"],
    "iu": ["iu"],
    "o": ["o", "ö"],
    "oo": ["ö", "u"],
    "ou": ["ou", "u"],
    "oy": ["öj"],
    "u": ["u", "y"],
    "ue": ["ü", "y"],
    "ui": ["ui"],
    "uy": ["y"],
    "y": ["y", "i"],
    "ya": ["ja"],
    "ye": ["je"],
    "yi": ["ji"],
    "yo": ["jo"],
    "yu": ["ju"],
    # Consonant combinations
    "b": ["b"],
    "bb": ["bb"],
    "bt": ["bt"],
    "c": ["k", "s"],
    "cc": ["kk"],
    "ch": ["k", "tj"],
    "ck": ["ck", "k"],
    "d": ["d"],
    "dd": ["dd"],
    "dg": ["g"],
    "dj": ["j"],
    "dt": ["t"],
    "f": ["f"],
    "ff": ["ff"],
    "ft": ["ft"],
    "g": ["g"],
    "gg": ["gg"],
    "gh": ["g", ""],
    "gn": ["gn"],
    "gu": ["g"],
    "h": ["h", ""],
    "hl": ["l"],
    "hn": ["n"],
    "hr": ["r"],
    "ht": ["t"],
    "j": ["j"],
    "k": ["k"],
    "kk": ["ck"],
    "kn": ["kn"],
    "l": ["l"],
    "ll": ["ll"],
    "ln": ["ln"],
    "lt": ["lt"],
    "m": ["m"],
    "mb": ["m"],
    "mm": ["mm"],
    "mn": ["mn"],
    "mp": ["mp"],
    "n": ["n"],
    "nd": ["nd"],
    "ng": ["ng"],
    "nk": ["nk"],
    "nn": ["nn"],
    "nt": ["nt"],
    "p": ["p"],
    "ph": ["f"],
    "pp": ["pp"],
    "pt": ["pt"],
    "qu": ["kv"],
    "r": ["r"],
    "rr": ["rr"],
    "rt": ["rt"],
    "s": ["s"],
    "sc": ["sk"],
    "sh": ["sj", "sch"],
    "sk": ["sk"],
    "sl": ["sl"],
    "sm": ["sm"],
    "sn": ["sn"],
    "sp": ["sp"],
    "ss": ["ss"],
    "st": ["st"],
    "sw": ["sv"],
    "t": ["t"],
    "th": ["t"],
    "tt": ["tt"],
    "tw": ["tv"],
    "v": ["v"],
    "w": ["v"],
    "wh": ["v"],
    "wr": ["r"],
    "x": ["ks"],
    "z": ["s"],
    # Common English name endings to Swedish
    "son": ["son", "sson"],
    "sen": ["sen"],
    "berg": ["berg"],
    "burg": ["borg"],
    "ley": ["li"],
    "lyn": ["lin"],
    "ton": ["ton"],
    "ham": ["ham"],
    "ford": ["ford"],
    "wood": ["skog"],
    "field": ["fält"],
    "land": ["land"],
    "man": ["man"],
    "er": ["er"],
    "ard": ["ard"],
    "and": ["and"],
    # Swedish specific patterns
    "sj": ["sj"],
    "skj": ["skj"],
    "stj": ["stj"],
    "tj": ["tj"],
}

danish_rules = {
    # Vowel combinations and single vowels
    "a": ["å", "a"],
    "ae": ["æ", "ø"],
    "oe": ["ø", "ö"],
    "aa": ["å"],
    "ao": ["å"],
    "e": ["e", "æ"],
    "ea": ["æ", "e"],
    "ee": ["e"],
    "ei": ["ej", "ai"],
    "eu": ["ø"],
    "i": ["i"],
    "ie": ["ie", "i"],
    "io": ["io"],
    "iu": ["iu"],
    "o": ["o", "ø"],
    "oo": ["ø", "u"],
    "ou": ["ou", "u"],
    "oy": ["øj"],
    "u": ["u", "y"],
    "ue": ["y"],
    "ui": ["ui"],
    "uy": ["y"],
    "y": ["y", "i"],
    "ya": ["ja"],
    "ye": ["je"],
    "yi": ["ji"],
    "yo": ["jo"],
    "yu": ["ju"],
    # Consonant combinations
    "b": ["b"],
    "bb": ["bb"],
    "bt": ["bt"],
    "c": ["k", "s"],
    "cc": ["kk"],
    "ch": ["k"],
    "ck": ["k"],
    "d": ["d", ""],
    "dd": ["dd"],
    "dg": ["g"],
    "dj": ["j"],
    "dt": ["t"],
    "f": ["f"],
    "ff": ["ff"],
    "ft": ["ft"],
    "g": ["g", ""],
    "gg": ["gg"],
    "gh": ["g", ""],
    "gn": ["gn"],
    "gu": ["g"],
    "h": ["h", ""],
    "hl": ["l"],
    "hn": ["n"],
    "hr": ["r"],
    "ht": ["t"],
    "j": ["j"],
    "k": ["k"],
    "kk": ["kk"],
    "kn": ["kn"],
    "l": ["l"],
    "ll": ["ll"],
    "ln": ["ln"],
    "lt": ["lt"],
    "m": ["m"],
    "mb": ["m"],
    "mm": ["mm"],
    "mn": ["mn"],
    "mp": ["mp"],
    "n": ["n"],
    "nd": ["nd"],
    "ng": ["ng"],
    "nk": ["nk"],
    "nn": ["nn"],
    "nt": ["nt"],
    "p": ["p"],
    "ph": ["f"],
    "pp": ["pp"],
    "pt": ["pt"],
    "qu": ["kv"],
    "r": ["r"],
    "rr": ["rr"],
    "rt": ["rt"],
    "s": ["s"],
    "sc": ["sk"],
    "sh": ["sj"],
    "sk": ["sk"],
    "sl": ["sl"],
    "sm": ["sm"],
    "sn": ["sn"],
    "sp": ["sp"],
    "ss": ["ss"],
    "st": ["st"],
    "sw": ["sv"],
    "t": ["t", ""],
    "th": ["t"],
    "tt": ["tt"],
    "tw": ["tv"],
    "v": ["v"],
    "w": ["v"],
    "wh": ["v"],
    "wr": ["r"],
    "x": ["ks"],
    "z": ["s"],
    # Common English name endings to Danish
    "son": ["sen", "søn"],
    "sen": ["sen"],
    "berg": ["berg"],
    "burg": ["borg"],
    "ley": ["li"],
    "lyn": ["lin"],
    "ton": ["ton"],
    "ham": ["ham"],
    "ford": ["ford"],
    "wood": ["skov"],
    "field": ["mark"],
    "land": ["land"],
    "man": ["mand"],
    "er": ["er"],
    "ard": ["ard"],
    "and": ["and"],
}

icelandic_rules = {
    # Vowel combinations and single vowels
    "a": ["á", "a"],
    "ae": ["æ", "ö"],
    "oe": ["ö", "ø"],
    "aa": ["á"],
    "ao": ["á"],
    "e": ["e", "é"],
    "ea": ["æ", "e"],
    "ee": ["é"],
    "ei": ["ei"],
    "eu": ["ö"],
    "i": ["í", "i"],
    "ie": ["ie", "í"],
    "io": ["io"],
    "iu": ["iu"],
    "o": ["ó", "o"],
    "oo": ["ó", "ú"],
    "ou": ["ou", "ú"],
    "oy": ["ey"],
    "u": ["ú", "u"],
    "ue": ["y"],
    "ui": ["ui"],
    "uy": ["y"],
    "y": ["ý", "i"],
    "ya": ["ja"],
    "ye": ["je"],
    "yi": ["ji"],
    "yo": ["jó"],
    "yu": ["jú"],
    # Consonant combinations
    "b": ["b"],
    "bb": ["bb"],
    "bt": ["bt"],
    "c": ["k", "s"],
    "cc": ["kk"],
    "ch": ["k"],
    "ck": ["kk"],
    "d": ["d"],
    "dd": ["dd"],
    "dg": ["g"],
    "dj": ["j"],
    "dt": ["t"],
    "f": ["f"],
    "ff": ["ff"],
    "ft": ["ft"],
    "g": ["g"],
    "gg": ["gg"],
    "gh": ["g"],
    "gn": ["gn"],
    "gu": ["g"],
    "h": ["h"],
    "hl": ["l"],
    "hn": ["n"],
    "hr": ["r"],
    "ht": ["t"],
    "j": ["j"],
    "k": ["k"],
    "kk": ["kk"],
    "kn": ["kn"],
    "l": ["l"],
    "ll": ["ll"],
    "ln": ["ln"],
    "lt": ["lt"],
    "m": ["m"],
    "mb": ["m"],
    "mm": ["mm"],
    "mn": ["mn"],
    "mp": ["mp"],
    "n": ["n"],
    "nd": ["nd"],
    "ng": ["ng"],
    "nk": ["nk"],
    "nn": ["nn"],
    "nt": ["nt"],
    "p": ["p"],
    "ph": ["f"],
    "pp": ["pp"],
    "pt": ["pt"],
    "qu": ["kv"],
    "r": ["r"],
    "rr": ["rr"],
    "rt": ["rt"],
    "s": ["s"],
    "sc": ["sk"],
    "sh": ["sj"],
    "sk": ["sk"],
    "sl": ["sl"],
    "sm": ["sm"],
    "sn": ["sn"],
    "sp": ["sp"],
    "ss": ["ss"],
    "st": ["st"],
    "sw": ["sv"],
    "t": ["t"],
    "th": ["þ", "ð"],
    "tt": ["tt"],
    "tw": ["tv"],
    "v": ["v"],
    "w": ["v"],
    "wh": ["hv"],
    "wr": ["r"],
    "x": ["ks"],
    "z": ["s"],
    # Common English name endings to Icelandic
    "son": ["son"],
    "sen": ["sen"],
    "berg": ["berg"],
    "burg": ["borg"],
    "ley": ["li"],
    "lyn": ["lín"],
    "ton": ["tón"],
    "ham": ["ham"],
    "ford": ["fjörður"],
    "wood": ["skógur"],
    "field": ["völlur"],
    "land": ["land"],
    "man": ["maður"],
    "er": ["ur"],
    "ard": ["ard"],
    "and": ["and"],
    # Icelandic specific letters
    "tor": ["þor"],
    "dh": ["ð"],
    "eth": ["ð"],
}

faroese_rules = {
    # Vowel combinations and single vowels
    "a": ["á", "a"],
    "ae": ["æ", "ø"],
    "oe": ["ø", "ö"],
    "aa": ["á"],
    "ao": ["á"],
    "e": ["e", "æ"],
    "ea": ["æ", "e"],
    "ee": ["e"],
    "ei": ["ei"],
    "eu": ["ø"],
    "i": ["í", "i"],
    "ie": ["ie", "í"],
    "io": ["io"],
    "iu": ["iu"],
    "o": ["ó", "o"],
    "oo": ["ó", "ú"],
    "ou": ["ou", "ú"],
    "oy": ["øy"],
    "u": ["ú", "u"],
    "ue": ["y"],
    "ui": ["ui"],
    "uy": ["y"],
    "y": ["ý", "i"],
    "ya": ["ja"],
    "ye": ["je"],
    "yi": ["ji"],
    "yo": ["jó"],
    "yu": ["jú"],
    # Consonant combinations
    "b": ["b"],
    "bb": ["bb"],
    "bt": ["bt"],
    "c": ["k", "s"],
    "cc": ["kk"],
    "ch": ["k"],
    "ck": ["kk"],
    "d": ["d"],
    "dd": ["dd"],
    "dg": ["g"],
    "dj": ["j"],
    "dt": ["t"],
    "f": ["f"],
    "ff": ["ff"],
    "ft": ["ft"],
    "g": ["g"],
    "gg": ["gg"],
    "gh": ["g"],
    "gn": ["gn"],
    "gu": ["g"],
    "h": ["h"],
    "hl": ["l"],
    "hn": ["n"],
    "hr": ["r"],
    "ht": ["t"],
    "j": ["j"],
    "k": ["k"],
    "kk": ["kk"],
    "kn": ["kn"],
    "l": ["l"],
    "ll": ["ll"],
    "ln": ["ln"],
    "lt": ["lt"],
    "m": ["m"],
    "mb": ["m"],
    "mm": ["mm"],
    "mn": ["mn"],
    "mp": ["mp"],
    "n": ["n"],
    "nd": ["nd"],
    "ng": ["ng"],
    "nk": ["nk"],
    "nn": ["nn"],
    "nt": ["nt"],
    "p": ["p"],
    "ph": ["f"],
    "pp": ["pp"],
    "pt": ["pt"],
    "qu": ["kv"],
    "r": ["r"],
    "rr": ["rr"],
    "rt": ["rt"],
    "s": ["s"],
    "sc": ["sk"],
    "sh": ["sj"],
    "sk": ["sk"],
    "sl": ["sl"],
    "sm": ["sm"],
    "sn": ["sn"],
    "sp": ["sp"],
    "ss": ["ss"],
    "st": ["st"],
    "sw": ["sv"],
    "t": ["t"],
    "th": ["ð"],
    "tt": ["tt"],
    "tw": ["tv"],
    "v": ["v"],
    "w": ["v"],
    "wh": ["hv"],
    "wr": ["r"],
    "x": ["ks"],
    "z": ["s"],
    # Common English name endings to Faroese
    "son": ["son"],
    "sen": ["sen"],
    "berg": ["berg"],
    "burg": ["borg"],
    "ley": ["li"],
    "lyn": ["lín"],
    "ton": ["tón"],
    "ham": ["ham"],
    "ford": ["fjørður"],
    "wood": ["skógur"],
    "field": ["völlur"],
    "land": ["land"],
    "man": ["maður"],
    "er": ["ur"],
    "ard": ["ard"],
    "and": ["and"],
    # Faroese specific letters
    "tor": ["ðor"],
    "dh": ["ð"],
    "eth": ["ð"],
}


def get_rules_for_country(country: ScandinavianCountry) -> Dict[str, List[str]]:
    return {
        ScandinavianCountry.Norway: norwegian_rules,
        ScandinavianCountry.Sweden: swedish_rules,
        ScandinavianCountry.Denmark: danish_rules,
        ScandinavianCountry.Iceland: icelandic_rules,
        ScandinavianCountry.FaroeIslands: faroese_rules,
    }.get(country, norwegian_rules)


def to_lower(s: str) -> str:
    return s.lower()


def capitalize_scandinavian(s: str) -> str:
    if not s:
        return s
    upper_map = {
        "æ": "Æ",
        "ø": "Ø",
        "å": "Å",
        "þ": "Þ",
        "ä": "Ä",
        "ö": "Ö",
        "ü": "Ü",
        "í": "Í",
        "á": "Á",
        "ð": "Ð",
        "ó": "Ó",
    }
    first_char = s[0]
    if first_char in upper_map:
        return upper_map[first_char] + s[1:]
    return first_char.upper() + s[1:]


def generate_all_variants(
    input_str: str,
    pos: int,
    current: str,
    results: Set[str],
    rules: Dict[str, List[str]],
):
    if pos >= len(input_str):
        results.add(current)
        return

    rule_applied = False
    for key, replacements in rules.items():
        length = len(key)
        if (
            pos + length <= len(input_str)
            and to_lower(input_str[pos : pos + length]) == key
        ):
            rule_applied = True
            for rep in replacements:
                generate_all_variants(
                    input_str, pos + length, current + rep, results, rules
                )

    # Always allow the branch with no rule applied
    generate_all_variants(input_str, pos + 1, current + input_str[pos], results, rules)


def transliterate_all(name: str, country: ScandinavianCountry) -> List[str]:
    results = set()
    rules = get_rules_for_country(country)
    generate_all_variants(name, 0, "", results, rules)
    return [capitalize_scandinavian(r) for r in results]


def print_variants(variants: List[str]):
    print(", ".join(variants))


def transliterate_names(fullname: str, country_name: ScandinavianCountry, fuzzy: bool):
    print(f"Input name: {fullname}")
    try:
        country = ScandinavianCountry[country_name]
    except KeyError:
        print(f"Invalid country name: {country_name}. Defaulting to Norway.")
        country = ScandinavianCountry.Norway

    countries = [
        ScandinavianCountry.Norway,
        ScandinavianCountry.Sweden,
        ScandinavianCountry.Denmark,
        ScandinavianCountry.Iceland,
        ScandinavianCountry.FaroeIslands,
    ]

    print(f"\n{country.name} variants for {fullname}: ", end="")
    transliterations = transliterate_all(fullname, country)
    print_variants(transliterations)
    if fuzzy:
        return correct_name(transliterations, str(country))
    else:
        return transliterations
